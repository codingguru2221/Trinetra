package com.trinetra.scanner;

import com.trinetra.utils.Logger;
import com.trinetra.attacks.ScannerAttack;
import com.trinetra.attacks.ScannerAttackFactory;
import java.util.Arrays;
import java.util.List;
import java.util.ArrayList;
import java.net.URL;
import java.net.HttpURLConnection;
import java.io.IOException;

/**
 * Scanner component for detecting vulnerabilities in systems
 */
public class VulnerabilityScanner {
    
    // Common vulnerability patterns
    private static final List<String> SQL_INJECTION_PATTERNS = Arrays.asList(
        "' OR '1'='1", 
        "'; DROP TABLE", 
        "UNION SELECT", 
        "SELECT * FROM"
    );
    
    private static final List<String> XSS_PATTERNS = Arrays.asList(
        "<script>", 
        "javascript:", 
        "onload=", 
        "onclick="
    );
    
    public VulnerabilityScanner() {
        // Constructor
    }
    
    /**
     * Perform a vulnerability scan based on provided arguments
     * @param args Command line arguments for the scan
     */
    public void performScan(String[] args) {
        Logger.info("VulnerabilityScanner: Starting scan with arguments: " + Arrays.toString(args));
        
        // Parse arguments
        String target = null;
        boolean verbose = false;
        String scanType = "full"; // default scan type
        
        for (int i = 0; i < args.length; i++) {
            if ("--target".equals(args[i]) && i + 1 < args.length) {
                target = args[i + 1];
                i++; // Skip next argument
            } else if ("--verbose".equals(args[i])) {
                verbose = true;
            } else if ("--type".equals(args[i]) && i + 1 < args.length) {
                scanType = args[i + 1];
                i++; // Skip next argument
            }
        }
        
        if (target == null) {
            Logger.error("VulnerabilityScanner: No target specified for scan");
            System.out.println("Error: Please specify a target using --target <url>");
            return;
        }
        
        // Validate URL format
        if (!isValidUrl(target)) {
            Logger.error("VulnerabilityScanner: Invalid URL format: " + target);
            System.out.println("Error: Invalid URL format. Please provide a valid URL (e.g., http://example.com)");
            return;
        }
        
        Logger.info("VulnerabilityScanner: Scanning target: " + target);
        
        if (verbose) {
            Logger.debug("VulnerabilityScanner: Verbose mode enabled");
        }
        
        // Check if target is reachable
        if (!isTargetReachable(target, verbose)) {
            Logger.warn("VulnerabilityScanner: Target may not be reachable: " + target);
            System.out.println("Warning: Target may not be reachable. Scan will continue but results may be limited.");
        }
        
        // Perform scan based on type using new attack classes
        switch (scanType.toLowerCase()) {
            case "portscan":
                executeScannerAttack("portscan", target);
                break;
            case "directory":
                executeScannerAttack("directory", target);
                break;
            case "full":
            default:
                performFullScan(target, verbose);
                break;
        }
        
        Logger.info("VulnerabilityScanner: Scan completed");
    }
    
    /**
     * Execute a specific scanner attack
     * @param attackType Type of scanner attack to execute
     * @param target Target for the attack
     */
    private void executeScannerAttack(String attackType, String target) {
        try {
            ScannerAttack attack = ScannerAttackFactory.createScannerAttack(attackType, target);
            System.out.println(attack.getDetails());
            attack.execute();
        } catch (IllegalArgumentException e) {
            Logger.error("Unknown scanner attack type: " + attackType);
            System.out.println("Error: Unknown scanner attack type: " + attackType);
        }
    }
    
    private boolean isValidUrl(String url) {
        try {
            new URL(url);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    private boolean isTargetReachable(String target, boolean verbose) {
        try {
            URL url = new URL(target);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");
            connection.setConnectTimeout(5000); // 5 seconds
            connection.setReadTimeout(5000); // 5 seconds
            
            int responseCode = connection.getResponseCode();
            if (verbose) {
                Logger.debug("Target reachability check - Response code: " + responseCode);
            }
            return responseCode < 400;
        } catch (IOException e) {
            if (verbose) {
                Logger.debug("Target reachability check failed: " + e.getMessage());
            }
            return false;
        }
    }
    
    private void performFullScan(String target, boolean verbose) {
        System.out.println("Performing full vulnerability scan on " + target + "...");
        
        // Simulate different types of scans
        simulatePortScan(target, verbose);
        simulateSqlInjectionScan(target, verbose);
        simulateXssScan(target, verbose);
        simulateSecurityHeaderScan(target, verbose);
        
        generateFullScanReport(target);
    }
    
    private void performSqlInjectionScan(String target, boolean verbose) {
        System.out.println("Performing SQL injection scan on " + target + "...");
        simulateSqlInjectionScan(target, verbose);
        generateSqlScanReport(target);
    }
    
    private void performXssScan(String target, boolean verbose) {
        System.out.println("Performing XSS vulnerability scan on " + target + "...");
        simulateXssScan(target, verbose);
        generateXssScanReport(target);
    }
    
    private void simulatePortScan(String target, boolean verbose) {
        System.out.println("[+] Scanning open ports...");
        if (verbose) {
            System.out.println("    Port 21: CLOSED");
            System.out.println("    Port 22: OPEN (SSH)");
            System.out.println("    Port 23: CLOSED");
            System.out.println("    Port 25: CLOSED");
            System.out.println("    Port 53: OPEN (DNS)");
            System.out.println("    Port 80: OPEN (HTTP)");
            System.out.println("    Port 110: CLOSED");
            System.out.println("    Port 443: OPEN (HTTPS)");
            System.out.println("    Port 3306: OPEN (MySQL)");
        }
    }
    
    private void simulateSqlInjectionScan(String target, boolean verbose) {
        System.out.println("[+] Testing for SQL injection vulnerabilities...");
        if (verbose) {
            System.out.println("    Testing login form with payload: ' OR '1'='1");
            System.out.println("    Testing search parameter with payload: UNION SELECT username,password FROM users");
            System.out.println("    Testing ID parameter with payload: ; DROP TABLE users;");
        }
    }
    
    private void simulateXssScan(String target, boolean verbose) {
        System.out.println("[+] Testing for XSS vulnerabilities...");
        if (verbose) {
            System.out.println("    Testing search parameter with payload: <script>alert('XSS')</script>");
            System.out.println("    Testing comment form with payload: javascript:alert('XSS')");
            System.out.println("    Testing URL parameter with payload: onload=alert('XSS')");
        }
    }
    
    private void simulateSecurityHeaderScan(String target, boolean verbose) {
        System.out.println("[+] Checking security headers...");
        if (verbose) {
            System.out.println("    X-Content-Type-Options: MISSING");
            System.out.println("    X-Frame-Options: SAMEORIGIN");
            System.out.println("    X-XSS-Protection: 1; mode=block");
            System.out.println("    Strict-Transport-Security: MISSING");
            System.out.println("    Content-Security-Policy: MISSING");
        }
    }
    
    private void generateFullScanReport(String target) {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("FULL VULNERABILITY SCAN REPORT");
        System.out.println("Target: " + target);
        System.out.println("=".repeat(50));
        System.out.println("CRITICAL Vulnerabilities:");
        System.out.println("  1. SQL Injection vulnerability in login form");
        System.out.println("  2. Cross-site scripting (XSS) in search functionality");
        System.out.println("\nHIGH Vulnerabilities:");
        System.out.println("  1. Missing security headers (HSTS, CSP)");
        System.out.println("  2. Open MySQL port (3306) accessible from public");
        System.out.println("\nMEDIUM Vulnerabilities:");
        System.out.println("  1. Weak password policy detected");
        System.out.println("  2. Directory listing enabled on /images/");
        System.out.println("\nRECOMMENDATIONS:");
        System.out.println("  1. Implement input validation for all user inputs");
        System.out.println("  2. Add Content Security Policy headers");
        System.out.println("  3. Restrict access to MySQL port");
        System.out.println("  4. Implement proper authentication mechanisms");
    }
    
    private void generateSqlScanReport(String target) {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("SQL INJECTION SCAN REPORT");
        System.out.println("Target: " + target);
        System.out.println("=".repeat(50));
        System.out.println("Vulnerabilities Found:");
        System.out.println("  1. SQL Injection in login form (CRITICAL)");
        System.out.println("  2. Union-based SQL Injection in search (HIGH)");
        System.out.println("\nRECOMMENDATIONS:");
        System.out.println("  1. Use parameterized queries or prepared statements");
        System.out.println("  2. Implement input validation and sanitization");
        System.out.println("  3. Apply principle of least privilege for database users");
    }
    
    private void generateXssScanReport(String target) {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("XSS VULNERABILITY SCAN REPORT");
        System.out.println("Target: " + target);
        System.out.println("=".repeat(50));
        System.out.println("Vulnerabilities Found:");
        System.out.println("  1. Reflected XSS in search parameter (HIGH)");
        System.out.println("  2. Stored XSS in comment functionality (CRITICAL)");
        System.out.println("\nRECOMMENDATIONS:");
        System.out.println("  1. Encode output data before rendering in browser");
        System.out.println("  2. Implement Content Security Policy (CSP)");
        System.out.println("  3. Validate and sanitize all user inputs");
    }
}